{% extends "layout.html" %}
{% block title %}Dashboard {{ depto }}{% endblock %}
{% block content %}
    <div class="d-flex justify-content-between mb-3"></div>
        <h2>Dashboard de {{ depto }}</h2>
    <div>
        <a href="{{ url_for('ayuda') }}" class="btn btn-warning me-2">‚ùì Ayuda</a>
        <a href="{{ url_for('logout') }}" class="btn btn-secondary">üîí Salir</a>
    </div>
  </div>

  <a href="{{ url_for('reporte_departamento', dept_id=depto.id) }}"
   class="btn btn-outline-success mb-3">
  Descargar Reporte HTML
</a>

  <h4>Estad√≠sticas</h4>
  <ul class="list-group mb-4">
    {% for estado, cant in estadisticas.items() %}
      <li class="list-group-item d-flex justify-content-between">
        {{ estado.replace('_',' ')|capitalize }}
        <span class="badge bg-primary">{{ cant }}</span>
      </li>
    {% endfor %}
  </ul>

 <h4>Top palabras (global)</h4>
<div
  id="word-cloud-global"
  style="width:100%; height:300px; border:1px solid #ddd;"
  data-words='[
    {% for palabra, conteo in top_pal %}
      ["{{ palabra|escapejs }}", {{ conteo }}]{% if not loop.last %},{% endif %}
    {% endfor %}
  ]'
></div>

<script type="text/javascript">
  document.addEventListener("DOMContentLoaded", () => {
    const cont = document.getElementById("word-cloud-global");
    const wordsGlobal = JSON.parse(cont.getAttribute("data-words"));
    console.log("Nube de palabras:", wordsGlobal);
    WordCloud(cont, {
      list: wordsGlobal,
      gridSize: Math.round(16 * cont.offsetWidth / 1024),
      weightFactor: size => Math.pow(size,1.1)*5,
      fontFamily: "Helvetica, Arial, sans-serif",
      color: "random-dark",
      rotateRatio: 0.1,
      backgroundColor: "#f8f9fa"
    });
  });
</script>

  <h4>Mis reclamos pendientes</h4>
  <ul class="list-group">
    {% for r in reclamos_pendientes %}
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <div>
          <strong>#{{ r.id_reclamo }}</strong> ‚Äì {{ r.contenido }}
          <br>
          <small class="text-muted">
             Estado: {{ r.estado.replace('_',' ') }} |
             {{ r.timestamp.strftime('%d/%m/%Y %H:%M') }}
          </small>
        </div>
        <form method="post" action="{{ url_for('manejar_reclamo') }}" class="d-flex">
          <input type="hidden" name="reclamo_id" value="{{ r.id_reclamo }}">
          <select name="nuevo_estado" class="form-select me-2">
            {% for est in ['pendiente','en_proceso','resuelto','invalido'] %}
              <option value="{{ est }}" {% if r.estado == est %}selected{% endif %}>
                {{ est.replace('_',' ')|capitalize }}
              </option>
            {% endfor %}
          </select>
          <button type="submit" class="btn btn-sm btn-primary">Actualizar</button>
        </form>
      </li>
    {% endfor %}
  </ul>
{% endblock %}
